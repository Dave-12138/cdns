"use strict";const g=require("node:fs");var u=(t=>(t.bbb="1",t.bh3="1",t.b3="1",t.ys="2",t.genshin="2",t.bb="3",t.b2="3",t.wd="4",t.dby="5",t.hsr="6",t.bt="6",t.zzz="8",t))(u||{});function y(t,c){const r=new Date(c*1e3).getFullYear(),n=t.includes("年")?t:r+"年"+t,a=new Date(n.replace(/[^\d]/g,"/"));for(;a.getDay()!=4;)a.setDate(a.getDate()-1);return a}function S(t){return`${t.getFullYear()}年${t.getMonth()+1}月${t.getDate()}日`}const D=/(?:((?:\d{1,4}年)?\d{1,2}月\d{1,2}日)\d{1,2}:00|.*版本更新后)~((?:\d{1,4}年)?\d{1,2}月\d{1,2}日)\d{1,2}:00/;async function x(){var s;const t=u.bh3,r=(await h("作战凭证开启",t)).filter(e=>D.test(e.post.structured_content)).map(e=>{const[d,l,p]=D.exec(e.post.structured_content)??[],f=y(l||S(new Date((e.post.created_at+7*24*3600)*1e3)),e.post.created_at),N=y(p,e.post.created_at);return{date:f,game:t,next:N,desc:e.post.subject.replace(/【公告】(.*)作战凭证开启/,"$1")}}),n=r.reduce((e,d)=>e.next>d.next?e:d),a=r.map(e=>({desc:e.desc,date:e.date,game:t})),o=((s=n.desc.match(/\d\.\d/))==null?void 0:s.map(e=>Number.parseFloat(e)))??[NaN];o[0]+=.1,a.unshift({desc:`v${o[0].toFixed(1)}`,date:n.next,game:t});const i=a.map(e=>({date:new Date(e.date.valueOf()-5*24*3600*1e3),desc:e.desc+"前瞻",game:t}));return a.push(...i),a}function F(t){return typeof t=="string"?t:isNaN(t)?"没有数字版本号的新版本":`v${t.toFixed(1)}`}function _(t){var r,n;const c=((r=t.desc.match(/\d\.\d/))==null?void 0:r.map(a=>Number.parseFloat(a)))??[NaN];if(isNaN(c[0])){const a={呈示:6,复演:6.1,间奏:6.2};c[0]=a[((n=t.desc.match(new RegExp("(?<=『空月之歌·).+(?=』)")))==null?void 0:n[0])??"?"]}return c[0]*10%10==8&&(c[0]+=.1),c[0]+=.1,c[0]}async function $(){const t=async(c,r)=>{const n=(await h(r,c)).filter(s=>s.forum.name=="官方"),a=n.map(s=>new RegExp("(?<=》)((?:\\d\\.\\d版本)?.*)将于((?:\\d{4}年)?\\d{1,2}月\\d{1,2}日)(?:正式)?上线").exec(s.post.content)).filter(s=>s!==null).map(([s,e,d])=>({game:c,desc:e,date:new Date(d.replace(/^(?=\d{1,2}月)/,()=>{var p;let l=(((p=n.find(f=>f.post.content.includes(s)))==null?void 0:p.post.created_at)??Date.now()/1e3)*1e3;return new Date(l).getFullYear()+"年"}).replace(/[^\d]/g,"/"))})),o=a.reduce((s,e)=>s.date>e.date?s:e),i=_(o);return a.unshift({game:c,desc:F(i),date:new Date(36288e5+Date.parse(o.date.toJSON()))}),a.filter((s,e,d)=>d.findIndex(l=>l.desc==s.desc)==e)};return(await Promise.all([t(u.ys,"感谢各位旅行者的支持与陪伴，我们将为大家带来更多"),t(u.hsr,"本次特别节目中的一切人物、故事、设定仅为节目包装"),t(u.zzz,"前瞻特别节目 日正式上线")])).flat()}const m=/》(.*)前瞻特别节目，?将于((?:\d+年)?\d+月\d+日)(?:（.+?）)?(\d{1,2}:\d{1,2})/;function z(t,c){const r=new Date(c*1e3).getFullYear(),n=t.includes("年")?t:r+"年"+t;return new Date(n.replace(/[^\d]/g,"/"))}const w=async t=>(await h("前瞻特别节目预告",t)).filter(n=>n.forum.name=="官方"&&m.test(n.post.content)).map(n=>{const[a,o,i,s]=m.exec(n.post.content)??[];return{desc:o.replace(new RegExp("(?<=版本).*"),"")+"前瞻"+s,date:z(i,n.post.created_at),game:t}});async function L(){return(await Promise.all([w(u.ys),w(u.hsr),w(u.zzz)])).flat()}const b="https://bbs-api.miyoushe.com/post/wapi/searchPosts?",P=typeof window>"u"?b:"/api/proxy/"+b;async function h(t,c,r="1",n="50"){const a=new URLSearchParams({gids:c,size:n,keyword:t,last_id:r});return await fetch(P+a).then(o=>o.json()).then(o=>o.data.posts.filter(i=>i.forum.name=="官方"))}async function Y(){return(await Promise.all([x(),$(),L()])).flat().map(t=>({game:t.game,date:t.date.toLocaleDateString("zh-Hans-CN"),desc:t.desc}))}(async function(){const t=new Date;function c(r){const[n,a,o,i]=r.date.match(/^(\d+|\*)\/(\d+|\*)\/(\d+|\*)$/)??[],s={y:a,m:o,d:i};function e(d){if(s[d]=="*")switch(d){case"y":return t.getFullYear().toString();case"m":return String(t.getMonth()+1);case"d":return String(t.getDate())}return s[d]}return r.date=Object.keys(s).reduce((d,l,p)=>d+(p?"/":"")+e(l),""),r}g.writeFileSync("miyoushe-calendar.json",await Promise.all([Y(),JSON.parse(g.readFileSync("custom_fes.json","utf-8"))]).then(([r,n])=>JSON.stringify([...r,...n.map(c)])))})();
