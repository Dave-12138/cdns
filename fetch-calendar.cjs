"use strict";const x=require("node:fs");var d=(t=>(t.bbb="1",t.bh3="1",t.b3="1",t.ys="2",t.genshin="2",t.bb="3",t.b2="3",t.wd="4",t.dby="5",t.hsr="6",t.bt="6",t.zzz="8",t))(d||{});function y(t,s){const r=new Date(s*1e3).getFullYear(),a=t.includes("年")?t:r+"年"+t,n=new Date(a.replace(/[^\d]/g,"/"));for(;n.getDay()!=4;)n.setDate(n.getDate()-1);return n}function N(t){return`${t.getFullYear()}年${t.getMonth()+1}月${t.getDate()}日`}const D=/(?:((?:\d{1,4}年)?\d{1,2}月\d{1,2}日)\d{1,2}:00|.*版本更新后)~((?:\d{1,4}年)?\d{1,2}月\d{1,2}日)\d{1,2}:00/;async function F(){var c;const t=d.bh3,r=(await h("作战凭证开启",t)).filter(e=>D.test(e.post.structured_content)).map(e=>{const[u,l,p]=D.exec(e.post.structured_content)??[],f=y(l||N(new Date((e.post.created_at+7*24*3600)*1e3)),e.post.created_at),m=y(p,e.post.created_at);return{date:f,game:t,next:m,desc:e.post.subject.replace(/【公告】(.*)作战凭证开启/,"$1")}}),a=r.reduce((e,u)=>e.next>u.next?e:u),n=r.map(e=>({desc:e.desc,date:e.date,game:t})),o=((c=a.desc.match(/\d\.\d/))==null?void 0:c.map(e=>Number.parseFloat(e)))??[NaN];o[0]+=.1,n.unshift({desc:`v${o[0].toFixed(1)}`,date:a.next,game:t});const i=n.map(e=>({date:new Date(e.date.valueOf()-5*24*3600*1e3),desc:e.desc+"前瞻",game:t}));return n.push(...i),n}function _(t){return typeof t=="string"?t:isNaN(t)?"没有数字版本号的新版本":`v${t.toFixed(1)}`}function $(t){var r,a;const s=((r=t.desc.match(/\d\.\d/))==null?void 0:r.map(n=>Number.parseFloat(n)))??[NaN];if(isNaN(s[0])){const n={呈示:6,复演:6.1,间奏:6.2};s[0]=n[((a=t.desc.match(new RegExp("(?<=『空月之歌·).+(?=』)")))==null?void 0:a[0])??"?"]}return s[0]*10%10==8&&(s[0]+=.1),s[0]+=.1,s[0]}async function z(){const t=async(s,r)=>{const a=(await h(r,s)).filter(c=>c.forum.name=="官方"),n=a.map(c=>new RegExp("(?<=》)((?:\\d\\.\\d版本)?.*)将于((?:\\d{4}年)?\\d{1,2}月\\d{1,2}日)(?:正式)?上线").exec(c.post.content)).filter(c=>c!==null).map(([c,e,u])=>({game:s,desc:e,date:new Date(u.replace(/^(?=\d{1,2}月)/,()=>{var p;let l=(((p=a.find(f=>f.post.content.includes(c)))==null?void 0:p.post.created_at)??Date.now()/1e3)*1e3;return new Date(l).getFullYear()+"年"}).replace(/[^\d]/g,"/"))})),o=n.reduce((c,e)=>c.date>e.date?c:e),i=$(o);return n.unshift({game:s,desc:_(i),date:new Date(36288e5+Date.parse(o.date.toJSON()))}),n.filter((c,e,u)=>u.findIndex(l=>l.desc==c.desc)==e)};return(await Promise.all([t(d.ys,"感谢各位旅行者的支持与陪伴，我们将为大家带来更多"),t(d.hsr,"本次特别节目中的一切人物、故事、设定仅为节目包装"),t(d.zzz,"前瞻特别节目 日正式上线")])).flat()}const g=/》(.*)前瞻特别节目，?将于((?:\d+年)?\d+月\d+日)(?:（.+?）)?(\d{1,2}:\d{1,2})/;function S(t,s){const r=new Date(s*1e3).getFullYear(),a=t.includes("年")?t:r+"年"+t;return new Date(a.replace(/[^\d]/g,"/"))}const w=async t=>(await h("前瞻特别节目预告",t)).filter(a=>a.forum.name=="官方"&&g.test(a.post.content)).map(a=>{const[n,o,i,c]=g.exec(a.post.content)??[];return{desc:o.replace(new RegExp("(?<=版本).*"),"")+"前瞻"+c,date:S(i,a.post.created_at),game:t}});async function L(){return(await Promise.all([w(d.ys),w(d.hsr),w(d.zzz)])).flat()}const b="https://bbs-api.miyoushe.com/post/wapi/searchPosts?",P=typeof window>"u"?b:"/api/proxy/"+b;async function h(t,s,r="1",a="50"){const n=new URLSearchParams({gids:s,size:a,keyword:t,last_id:r});return await fetch(P+n).then(o=>o.json()).then(o=>o.data.posts.filter(i=>i.forum.name=="官方"))}async function Y(){return(await Promise.all([F(),z(),L()])).flat().map(t=>({game:t.game,date:t.date.toLocaleDateString(),desc:t.desc}))}(async function(){x.writeFileSync("miyoushe-calendar.json",await Promise.all([Y()]).then(t=>JSON.stringify(t.flat())))})();
